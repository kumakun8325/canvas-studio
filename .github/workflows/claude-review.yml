# Auto Code Review (Claude Code)
#
# Features:
# - Automatically runs Claude Code review on PR creation
# - Uses code-review skill
# - Posts review results as PR comment
#
# Configuration:
# - Set ANTHROPIC_API_KEY or ZAI_API_KEY

name: Auto Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches: [main]

# åŒã˜PRã¸ã®é‡è¤‡å®Ÿè¡Œã‚’é˜²æ­¢
concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  claude-review:
    # Skip draft PRs
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Load shared config
        run: |
          source .github/config.env
          echo "CRITICAL_ISSUE_PATTERN=$CRITICAL_ISSUE_PATTERN" >> $GITHUB_ENV

      - name: Setup AI tools
        uses: ./.github/actions/setup-ai-tools
        with:
          install-claude: 'true'
          install-deps: 'false'
      
      - name: Get changed files
        id: changed
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx|py)$' | head -20 | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT
      
      - name: Run Claude Code Review
        if: steps.changed.outputs.files != ''
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
        run: |
          echo "Reviewing changed files..."
          REVIEW_AVAILABLE=true
          
          if [ -z "${ANTHROPIC_API_KEY:-}" ]; then
            REVIEW_AVAILABLE=false
            echo "::warning::ANTHROPIC_API_KEY is not set"
            echo "Claude Code requires ANTHROPIC_API_KEY." > review_output.txt
          elif ! command -v claude &> /dev/null; then
            REVIEW_AVAILABLE=false
            echo "::warning::Claude Code CLI is not available"
            echo "Claude Code CLI not found. Setup may have failed." > review_output.txt
          else
            if ! claude --dangerously-skip-permissions --print "Review the following files for quality, performance, and security: ${{ steps.changed.outputs.files }}" > review_output.txt 2>&1; then
              REVIEW_AVAILABLE=false
              echo "::warning::Claude Code review execution failed"
            fi
          fi

          if [ ! -s review_output.txt ]; then
            REVIEW_AVAILABLE=false
            echo "Claude review could not be completed. Please review manually." > review_output.txt
          fi

          echo "review_available=$REVIEW_AVAILABLE" >> $GITHUB_OUTPUT

          echo "::group::Review Output"
          cat review_output.txt
          echo "::endgroup::"
      
      - name: Comment on PR
        if: steps.changed.outputs.files != '' && steps.review.outputs.review_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          {
            echo "## ðŸ¤– Claude Code Review"
            echo ""
            echo "Changed files: \`${{ steps.changed.outputs.files }}\`"
            echo ""
            echo "<details>"
            echo "<summary>Review Results</summary>"
            echo ""
            echo '```'
            head -100 review_output.txt
            echo '```'
            echo ""
            echo "</details>"
            echo ""
            echo "---"
            echo "*Auto-generated by Claude Code*"
          } > /tmp/review_comment.md

          gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/review_comment.md

      - name: Submit formal PR review
        if: steps.changed.outputs.files != '' && steps.review.outputs.review_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          if [ ! -f review_output.txt ]; then
            echo "No review output, skipping formal review"
            exit 0
          fi

          if grep -qiE "$CRITICAL_ISSUE_PATTERN" review_output.txt; then
            gh pr review "$PR_NUMBER" --request-changes \
              --body "Claude Code review detected critical issues. See the review comment for details."
          else
            gh pr review "$PR_NUMBER" --approve \
              --body "Claude Code review passed. No critical issues found."
          fi

      - name: Check for critical issues
        if: steps.changed.outputs.files != '' && steps.review.outputs.review_available == 'true'
        id: check-issues
        run: |
          # Critical Issues / REQUEST_CHANGES / ðŸ”´ ã®ã„ãšã‚Œã‹ãŒã‚ã‚Œã°ä¿®æ­£ãŒå¿…è¦
          if grep -qiE "$CRITICAL_ISSUE_PATTERN" review_output.txt; then
            echo "needs_fix=true" >> $GITHUB_OUTPUT
            echo "Critical issues detected in Claude review"
          else
            echo "needs_fix=false" >> $GITHUB_OUTPUT
            echo "No critical issues found"
          fi

      - name: Trigger auto-fix workflow
        if: steps.check-issues.outputs.needs_fix == 'true' && steps.review.outputs.review_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ©ãƒ™ãƒ«è¿½åŠ ï¼ˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ç”¨ï¼‰
          gh pr edit ${{ github.event.pull_request.number }} \
            --add-label "auto-fix" \
            --add-label "claude-reviewed"

          # workflow_dispatch ã§è‡ªå‹•ä¿®æ­£ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•
          # Note: GITHUB_TOKEN ã§ã®ãƒ©ãƒ™ãƒ«è¿½åŠ ã¯ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ãªã„ãŸã‚
          # workflow_dispatch ã‚’ä½¿ç”¨ï¼ˆã“ã‚Œã¯ä¾‹å¤–çš„ã«ãƒˆãƒªã‚¬ãƒ¼å¯èƒ½ï¼‰
          # Note: workflow_dispatch ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©ã‚’å‚ç…§ã™ã‚‹ãŸã‚
          # åˆå›žãƒžãƒ¼ã‚¸å¾Œã‹ã‚‰æœ‰åŠ¹ã«ãªã‚‹
          if gh workflow run auto-apply-suggestions.yml \
            -f pr_number=${{ github.event.pull_request.number }} 2>/dev/null; then
            echo "Triggered auto-fix workflow via workflow_dispatch"
          else
            echo "::warning::workflow_dispatch trigger not available yet (requires merge to main)"
            echo "auto-fix label has been added for manual triggering"
          fi

      - name: Add reviewed label (no issues)
        if: steps.changed.outputs.files != '' && steps.check-issues.outputs.needs_fix == 'false' && steps.review.outputs.review_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} \
            --add-label "claude-reviewed"

      - name: No files to review
        if: steps.changed.outputs.files == ''
        run: echo "No files to review"
