# Auto Retry Failed Workflows
#
# トリガー:
# - Codex Review が失敗した時
# - Auto Apply Review Suggestions が失敗した時
#
# 機能:
# - 失敗したワークフローを自動で再試行
# - 最大3回までリトライ（指数的バックオフ）
# - 3回失敗したらIssueを作成して通知

name: Auto Retry Failed

on:
  workflow_run:
    workflows: ["Codex Review", "Auto Code Review", "Auto Apply Review Suggestions", "Claude Batch Implementation"]
    types: [completed]

jobs:
  check-retry-count:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    outputs:
      should_retry: ${{ steps.count.outputs.should_retry }}
      retry_count: ${{ steps.count.outputs.retry_count }}

    permissions:
      actions: read

    steps:
      - name: Get workflow run info
        id: info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          RUN_ID="${{ github.event.workflow_run.id }}"

          echo "Workflow: $WORKFLOW_NAME"
          echo "Run ID: $RUN_ID"

          # 失敗したワークフローのトリガー情報を取得
          gh run view $RUN_ID \
            --repo ${{ github.repository }} \
            --json triggeringActor,event,conclusion \
            --jq '{actor: .triggeringActor, event: .event, conclusion: .conclusion}' > run_info.json

          cat run_info.json

      - name: Check retry count
        id: count
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_NAME_SAFE=$(echo "$WORKFLOW_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          RUN_ATTEMPT="${{ github.event.workflow_run.run_attempt }}"

          echo "Workflow name (safe): $WORKFLOW_NAME_SAFE"
          echo "Run attempt: $RUN_ATTEMPT"

          if [ -z "$RUN_ATTEMPT" ]; then
            RUN_ATTEMPT=1
          fi

          echo "retry_count=$RUN_ATTEMPT" >> $GITHUB_OUTPUT

          if [ "$RUN_ATTEMPT" -lt 3 ]; then
            echo "should_retry=true" >> $GITHUB_OUTPUT
          else
            echo "should_retry=false" >> $GITHUB_OUTPUT
          fi

  retry-workflow:
    needs: check-retry-count
    if: needs.check-retry-count.result == 'success' && needs.check-retry-count.outputs.should_retry == 'true'
    runs-on: ubuntu-latest

    permissions:
      actions: write

    steps:
      - name: Calculate backoff delay
        id: backoff
        run: |
          RETRY_COUNT=${{ needs.check-retry-count.outputs.retry_count }}
          # 指数的バックオフ: 60s, 300s, 900s
          case "$RETRY_COUNT" in
            1) DELAY=60 ;;
            2) DELAY=300 ;;
            3) DELAY=900 ;;
            *) DELAY=0 ;;
          esac

          echo "delay=$DELAY" >> $GITHUB_OUTPUT
          echo "Backoff delay: ${DELAY}s"

      - name: Wait before retry
        run: sleep ${{ steps.backoff.outputs.delay }}

      - name: Trigger retry
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_RUN_ID="${{ github.event.workflow_run.id }}"
          NEXT_ATTEMPT=$(( ${{ needs.check-retry-count.outputs.retry_count }} + 1 ))

          echo "Triggering retry for: $WORKFLOW_NAME (run $WORKFLOW_RUN_ID)"

          gh run rerun "$WORKFLOW_RUN_ID" --failed
          echo "✅ Re-run triggered (attempt ${NEXT_ATTEMPT}/3)"

  create-alert-issue:
    needs: check-retry-count
    if: needs.check-retry-count.result == 'success' && needs.check-retry-count.outputs.should_retry == 'false'
    runs-on: ubuntu-latest

    permissions:
      issues: write

    steps:
      - name: Create alert issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_RUN_ID="${{ github.event.workflow_run.id }}"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"
          RUN_ATTEMPT="${{ github.event.workflow_run.run_attempt }}"

          if [ -z "$RUN_ATTEMPT" ]; then
            RUN_ATTEMPT=3
          fi

          cat > alert_issue.md << EOF
          ## Workflow Alert: Maximum Retry Attempts Reached

          ### Failed Workflow
          - Workflow: $WORKFLOW_NAME
          - Run ID: $WORKFLOW_RUN_ID
          - Retry Attempts: $RUN_ATTEMPT (maximum reached)

          ### Workflow URL
          [View Failed Workflow Run]($WORKFLOW_URL)

          ### Action Required
          This workflow has failed and exceeded the maximum retry attempts (3).
          Please investigate the root cause and fix manually.

          Possible causes:
          - API token issues
          - Network connectivity problems
          - Configuration errors
          - Code changes breaking the workflow

          ---
          Auto-generated by [Auto Retry Failed](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

          ISSUE_NUMBER=$(gh issue create \
            --title "Workflow Alert: Maximum Retries Reached - $WORKFLOW_NAME" \
            --label "workflow-alert" \
            --assignee ${{ github.repository_owner }} \
            --body-file alert_issue.md \
            --jq '.number')

          echo "Created alert issue #$ISSUE_NUMBER"
