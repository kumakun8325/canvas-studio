# Auto Apply Review Suggestions
#
# ãƒˆãƒªã‚¬ãƒ¼:
# - auto-fix ãƒ©ãƒ™ãƒ«ãŒè¿½åŠ ã•ã‚ŒãŸæ™‚
#   (Codex Review ã¾ãŸã¯ Claude Code Review ã§ Critical Issues æ¤œå‡ºæ™‚)
#
# æ©Ÿèƒ½:
# - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ä¿®æ­£å†…å®¹ã‚’æŠ½å‡ºï¼ˆCodex / Claude ä¸¡å¯¾å¿œï¼‰
# - ä¿®æ­£å›žæ•°ã«å¿œã˜ã¦AIã‚’é¸æŠžã—ã¦ä¿®æ­£ã‚’é©ç”¨:
#   - 1å›žç›®: Claude Code
#   - 2å›žç›®: GPT-5.2-Codex medium
#   - 3å›žç›®: GPT-5.2-Codex xhigh
# - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
# - ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦è‡ªå‹•å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼

name: Auto Apply Review Suggestions

on:
  pull_request:
    types: [labeled]
    branches: [main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to apply fixes to'
        required: true
        type: number

jobs:
  apply-fixes:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Claude/Copilotå®Ÿè¡Œã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    # labeled: auto-fix ãƒ©ãƒ™ãƒ«ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã®ã¿
    # workflow_dispatch: å¸¸ã«å®Ÿè¡Œï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.label.name == 'auto-fix' && github.event.pull_request.head.repo.full_name == github.repository)

    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: write

    steps:
      - name: Resolve PR info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

          PR_JSON=$(gh pr view "$PR_NUMBER" --json headRefName,title)
          HEAD_REF=$(echo "$PR_JSON" | jq -r '.headRefName')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title')
          echo "HEAD_REF=$HEAD_REF" >> $GITHUB_ENV
          echo "PR_TITLE=$PR_TITLE" >> $GITHUB_ENV

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.HEAD_REF }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Extract review suggestions
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
        run: |
          # Codex Review ã¨ Claude Code Review ã®ä¸¡æ–¹ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
          gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.body | test("GPT-5.2-Codex Review|Claude Code Review")) | .body' \
            > review_comments.txt || true

          if [ ! -s review_comments.txt ]; then
            echo "No review comments found"
            echo "has_critical_issues=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          cat review_comments.txt

          # Critical Issues ã®æ¤œå‡ºï¼ˆä¸¡æ–¹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å½¢å¼ã«å¯¾å¿œï¼‰
          if grep -qiE "(Critical Issues|REQUEST_CHANGES|ðŸ”´|severity.*critical)" review_comments.txt; then
            echo "has_critical_issues=true" >> $GITHUB_OUTPUT

            # Critical Issues ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
            {
              grep -A 100 "Critical Issues" review_comments.txt | grep -E "^\s*(-\s|###\s|\*\*)" || true
              grep -B 2 -A 5 "ðŸ”´" review_comments.txt || true
              grep -B 2 -A 5 -i "severity.*critical" review_comments.txt || true
            } | sort -u > critical_issues.txt

            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æŠ½å‡ºãŒç©ºã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆå…¨ä½“ã‚’ä½¿ç”¨
            if [ ! -s critical_issues.txt ]; then
              cat review_comments.txt > critical_issues.txt
            fi
          else
            echo "has_critical_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if fixable
        id: check-fixable
        if: steps.extract.outputs.has_critical_issues == 'true'
        run: |
          # è‡ªå‹•ä¿®æ­£ä¸å¯èƒ½ãªå•é¡Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
          UNFIXABLE_PATTERNS=(
            "Major refactoring needed"
            "Design change required"
            "External dependency issue"
            "Breaking change required"
            "Needs architectural review"
            "Requires discussion"
          )

          IS_FIXABLE=true

          for PATTERN in "${UNFIXABLE_PATTERNS[@]}"; do
            if grep -iq "$PATTERN" critical_issues.txt; then
              echo "Found unfixable pattern: $PATTERN"
              IS_FIXABLE=false
              break
            fi
          done

          if [ "$IS_FIXABLE" = true ]; then
            echo "is_fixable=true" >> $GITHUB_OUTPUT
            echo "âœ… Issues appear to be fixable"
          else
            echo "is_fixable=false" >> $GITHUB_OUTPUT
            echo "âŒ Issues require manual review"
          fi

      - name: Check fix attempt count
        id: check-count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_LABELS=$(gh pr view ${{ env.PR_NUMBER }} --json labels -q '.labels[].name')

          FIX_COUNT=0
          for i in 1 2 3 4 5; do
            if echo "$PR_LABELS" | grep -q "auto-fix-attempt-$i"; then
              FIX_COUNT=$i
            fi
          done

          FIX_COUNT=$((FIX_COUNT + 1))
          echo "fix_count=$FIX_COUNT" >> $GITHUB_OUTPUT

          if [ $FIX_COUNT -gt 5 ]; then
            echo "exceeded_max=true" >> $GITHUB_OUTPUT
            echo "âŒ Fix attempts exceeded maximum (5)"
          else
            echo "exceeded_max=false" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Fix attempt #$FIX_COUNT"
          fi

      - name: Determine AI model
        id: select-model
        env:
          FIX_COUNT: ${{ steps.check-count.outputs.fix_count }}
        run: |
          case "$FIX_COUNT" in
            1)
              MODEL="Claude Code"
              ;;
            2)
              MODEL="GPT-5.2-Codex (medium)"
              ;;
            *)
              MODEL="GPT-5.2-Codex (xhigh)"
              ;;
          esac

          echo "model=$MODEL" >> $GITHUB_OUTPUT
          echo "Using: $MODEL"

      - name: Remove auto-fix label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ env.PR_NUMBER }} \
            --remove-label "auto-fix" 2>/dev/null || true

      - name: Add attempt label
        if: steps.check-count.outputs.exceeded_max == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FIX_COUNT: ${{ steps.check-count.outputs.fix_count }}
        run: |
          ATTEMPT_LABEL="auto-fix-attempt-$FIX_COUNT"
          gh label create "$ATTEMPT_LABEL" --description "Auto-fix attempt $FIX_COUNT" --color "fbca04" 2>/dev/null || true
          gh pr edit ${{ env.PR_NUMBER }} \
            --add-label "$ATTEMPT_LABEL"

      - name: Comment on PR (started)
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODEL: ${{ steps.select-model.outputs.model }}
        run: |
          gh pr comment ${{ env.PR_NUMBER }} \
            --body "ðŸ”§ **Auto-fix started (${{ steps.select-model.outputs.model }})**

            Critical issues found in review. Applying automatic fixes...
            Attempt #${{ steps.check-count.outputs.fix_count }}/5

            This may take a few minutes.

            ---
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Apply fixes via Claude Code (1st attempt)
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false' && steps.check-count.outputs.fix_count == '1'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
        run: |
          cat > fix_prompt.txt << EOF
          ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ã«åŸºã¥ã„ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

          ## Critical Issues to Fix
          $(cat critical_issues.txt)

          ## Instructions
          1. ä¸Šè¨˜ã®Critical Issuesã‚’ä¿®æ­£ã—ã¦ãã ã•ã„
          2. ä¿®æ­£å¾Œã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ (npm run test:run)
          3. ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ãŸå ´åˆã¯ä¿®æ­£ã‚’ç¶šã‘ã¦ãã ã•ã„
          4. é‡è¦: ä¿®æ­£ãŒå®Œäº†ã—ãŸã‚‰ã€ã‚³ãƒŸãƒƒãƒˆã¯ã—ãªã„ã§ãã ã•ã„ï¼ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå‡¦ç†ã—ã¾ã™ï¼‰

          ## Requirements
          - Type Safety: anyã‚’ä½¿ç”¨ã—ãªã„
          - Architecture: ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã«å¾“ã† (components -> hooks -> services)
          - Security: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãªã—
          - Performance: é©åˆ‡ãªãƒ¡ãƒ¢åŒ–ã€ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãªã—
          - Testing: æ–°æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆãŒå¿…è¦

          é‡è¦: æ—¥æœ¬èªžã§èª¬æ˜Žã—ã¦ãã ã•ã„ã€‚
          EOF

          npm install -g @anthropic-ai/claude-code

          claude --dangerously-skip-permissions --print "$(cat fix_prompt.txt)" > claude_fix_output.txt 2>&1 || true

          echo "## ðŸ¤– Claude Fix Output" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -200 claude_fix_output.txt >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Apply fixes via GPT-5.2-Codex (medium, 2nd attempt)
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false' && steps.check-count.outputs.fix_count == '2'
        env:
          COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.COPILOT_GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > fix_prompt.txt << EOF
          ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ã«åŸºã¥ã„ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

          ## Critical Issues to Fix
          $(cat critical_issues.txt)

          ## Instructions
          1. ä¸Šè¨˜ã®Critical Issuesã‚’ä¿®æ­£ã—ã¦ãã ã•ã„
          2. ä¿®æ­£å¾Œã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ (npm run test:run)
          3. ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ãŸå ´åˆã¯ä¿®æ­£ã‚’ç¶šã‘ã¦ãã ã•ã„

          ## Requirements
          - Type Safety: anyã‚’ä½¿ç”¨ã—ãªã„
          - Architecture: ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã«å¾“ã† (components -> hooks -> services)
          - Security: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãªã—
          - Performance: é©åˆ‡ãªãƒ¡ãƒ¢åŒ–ã€ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãªã—
          - Testing: æ–°æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆãŒå¿…è¦

          é‡è¦: æ—¥æœ¬èªžã§èª¬æ˜Žã—ã¦ãã ã•ã„ã€‚
          é‡è¦: ã‚³ãƒŸãƒƒãƒˆã¯ä½œæˆã—ãªã„ã§ãã ã•ã„ã€‚å¤‰æ›´ã‚’é©ç”¨ã™ã‚‹ã ã‘ã§ã™ã€‚
          EOF

          npm install -g @github/copilot

          copilot -p "$(cat fix_prompt.txt)" \
            --model gpt-5.2-codex \
            --allow-all-tools \
            > codex_fix_output.txt 2>&1 || true

          echo "## ðŸ¤– GPT-5.2-Codex (medium) Fix Output" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -200 codex_fix_output.txt >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Apply fixes via GPT-5.2-Codex (xhigh, 3rd+ attempt)
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false' && steps.check-count.outputs.fix_count >= '3'
        env:
          COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.COPILOT_GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > fix_prompt.txt << EOF
          ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ã«åŸºã¥ã„ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
          ã“ã‚Œã¯ç¬¬${{ steps.check-count.outputs.fix_count }}å›žç›®ã®ä¿®æ­£è©¦è¡Œã§ã™ã€‚

          ## Critical Issues to Fix
          $(cat critical_issues.txt)

          ## Instructions
          1. ä¸Šè¨˜ã®Critical Issuesã‚’ä¿®æ­£ã—ã¦ãã ã•ã„
          2. ä¿®æ­£å¾Œã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ (npm run test:run)
          3. ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ãŸå ´åˆã¯ä¿®æ­£ã‚’ç¶šã‘ã¦ãã ã•ã„
          4. ä¿®æ­£å®Œäº†å¾Œã«è‡ªå·±ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã„ã€æ®‹ã£ãŸå•é¡ŒãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„

          ## Self-Review Checklist
          - ä¿®æ­£ã«ã‚ˆã£ã¦æ–°ãŸãªå•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹
          - ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦é€šéŽã—ã¦ã„ã‚‹ã‹
          - lintã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹
          - type errorãŒãªã„ã‹

          ## Requirements
          - Type Safety: anyã‚’ä½¿ç”¨ã—ãªã„
          - Architecture: ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã«å¾“ã† (components -> hooks -> services)
          - Security: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãªã—
          - Performance: é©åˆ‡ãªãƒ¡ãƒ¢åŒ–ã€ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãªã—
          - Testing: æ–°æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆãŒå¿…è¦

          é‡è¦: æ—¥æœ¬èªžã§èª¬æ˜Žã—ã¦ãã ã•ã„ã€‚
          é‡è¦: ã‚³ãƒŸãƒƒãƒˆã¯ä½œæˆã—ãªã„ã§ãã ã•ã„ã€‚å¤‰æ›´ã‚’é©ç”¨ã™ã‚‹ã ã‘ã§ã™ã€‚
          EOF

          npm install -g @github/copilot

          copilot -p "$(cat fix_prompt.txt)" \
            --model gpt-5.2-codex \
            --allow-all-tools \
            > codex_fix_output.txt 2>&1 || true

          echo "## ðŸ¤– GPT-5.2-Codex (xhigh) Fix Output" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -200 codex_fix_output.txt >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Run tests
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false'
        id: tests
        continue-on-error: true
        run: |
          set -o pipefail
          npm run test:run -- --no-color 2>&1 | tee test_results.txt
          TEST_EXIT=${PIPESTATUS[0]}

          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -50 test_results.txt >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          if [ $TEST_EXIT -eq 0 ]; then
            echo "test_status=success" >> $GITHUB_OUTPUT
            echo "test_desc=Tests passed" >> $GITHUB_OUTPUT
          else
            echo "test_status=failure" >> $GITHUB_OUTPUT
            echo "test_desc=Tests failed" >> $GITHUB_OUTPUT
          fi

      - name: Run lint
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false'
        id: lint
        continue-on-error: true
        run: |
          set -o pipefail
          npm run lint -- --no-color 2>&1 | tee lint_results.txt
          LINT_EXIT=${PIPESTATUS[0]}

          if [ $LINT_EXIT -eq 0 ]; then
            echo "lint_status=success" >> $GITHUB_OUTPUT
          else
            echo "lint_status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Clean up work files
        if: always()
        run: |
          rm -f claude_fix_output.txt codex_fix_output.txt fix_prompt.txt critical_issues.txt
          rm -f review_comments.txt test_results.txt lint_results.txt

      - name: Commit and push fixes
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false'
        id: commit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if [ -n "$(git status --porcelain)" ]; then
            git add .

            TEST_STATUS="${{ steps.tests.outputs.test_status }}"
            LINT_STATUS="${{ steps.lint.outputs.lint_status }}"
            FIX_COUNT="${{ steps.check-count.outputs.fix_count }}"
            MODEL="${{ steps.select-model.outputs.model }}"

            if [ "$TEST_STATUS" != "success" ]; then
              COMMIT_MSG="fix: apply code review suggestions (tests need review) [attempt $FIX_COUNT, $MODEL]"
            elif [ "$LINT_STATUS" != "success" ]; then
              COMMIT_MSG="fix: apply code review suggestions (linting issues) [attempt $FIX_COUNT, $MODEL]"
            else
              COMMIT_MSG="fix: apply code review suggestions [attempt $FIX_COUNT, $MODEL]"
            fi

            git commit -m "$COMMIT_MSG

            Auto-generated by GitHub Actions based on review feedback."
            git push origin HEAD:${{ env.HEAD_REF }}
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Re-trigger auto-fix if needed
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false' && steps.commit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FIX_COUNT: ${{ steps.check-count.outputs.fix_count }}
        run: |
          # 5å›žæœªæº€ã§ã‚ã‚Œã°ã€workflow_dispatch ã§å†ãƒˆãƒªã‚¬ãƒ¼
          if [ "$FIX_COUNT" -lt 5 ]; then
            gh workflow run auto-apply-suggestions.yml \
              -f pr_number=${{ env.PR_NUMBER }}
            echo "ðŸ”„ Re-triggered auto-fix via workflow_dispatch (attempt #$FIX_COUNT completed)"
          fi

      - name: Comment on PR (success)
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false' && steps.commit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_STATUS: ${{ steps.tests.outputs.test_status }}
          LINT_STATUS: ${{ steps.lint.outputs.lint_status }}
          FIX_COUNT: ${{ steps.check-count.outputs.fix_count }}
          MODEL: ${{ steps.select-model.outputs.model }}
        run: |
          STATUS_EMOJI="âœ…"
          if [ "$TEST_STATUS" != "success" ] || [ "$LINT_STATUS" != "success" ]; then
            STATUS_EMOJI="âš ï¸"
          fi

          gh pr comment ${{ env.PR_NUMBER }} \
            --body "$STATUS_EMOJI **Auto-fix completed ($MODEL)**

            Fixes have been applied and pushed.

            - Attempt: $FIX_COUNT/5
            - Tests: $TEST_STATUS
            - Lint: $LINT_STATUS

            The PR update will trigger an automatic re-review.

            ---
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Comment on PR (no changes)
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false' && steps.commit.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FIX_COUNT: ${{ steps.check-count.outputs.fix_count }}
          MODEL: ${{ steps.select-model.outputs.model }}
        run: |
          gh pr comment ${{ env.PR_NUMBER }} \
            --body "â„¹ï¸ **Auto-fix: No changes made ($MODEL)**

            AI reviewed the issues but did not make any code changes.
            This might mean:
            - The issues require manual review
            - The changes are already in place
            - Further clarification is needed

            Please review the issues manually.

            ---
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Request human review (unfixable)
        if: steps.check-fixable.outputs.is_fixable == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_COMMENT=$(cat review_comments.txt)

          cat > issue_body.md << EOF
          ## Manual Review Required - Unfixable Issues

          ### Pull Request
          - PR: #${{ env.PR_NUMBER }}
          - Title: ${{ env.PR_TITLE }}

          ### Review Feedback
          $REVIEW_COMMENT

          ### Why Manual Review?
          The automated review detected issues that require human intervention:
          - Major refactoring needed
          - Design change required
          - External dependency issue
          - Breaking change required
          - Architectural review needed
          - Requires discussion

          ### Next Steps
          Please review the PR and apply fixes manually.
          Once fixed, trigger a new Codex review by pushing changes or adding the `needs-review` label.

          ---
          Auto-generated by [Auto Apply Review Suggestions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

          ISSUE_NUMBER=$(gh issue create \
            --title "Manual Review Required: PR #${{ env.PR_NUMBER }}" \
            --label "human-review-needed" \
            --body-file issue_body.md \
            --jq '.number')

          gh pr edit ${{ env.PR_NUMBER }} \
            --remove-label "auto-fix"

          gh pr comment ${{ env.PR_NUMBER }} \
            --body "âŒ **Auto-fix: Issues require manual review**

            The detected issues need human intervention.

          Please review Issue #$ISSUE_NUMBER for details.

          ---
          [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Request human review (exceeded attempts)
        if: steps.check-count.outputs.exceeded_max == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # äººé–“ä»‹å…¥ä¾é ¼ã®Issueã‚’ä½œæˆ
          REVIEW_COMMENT=$(cat review_comments.txt)

          cat > issue_body.md << EOF
          ## Manual Review Required

          Auto-fix attempts have exceeded the maximum (5 attempts).

          ### Pull Request
          - PR: #${{ env.PR_NUMBER }}
          - Title: ${{ env.PR_TITLE }}

          ### Review Feedback
          $REVIEW_COMMENT

          ### Next Steps
          Please review the PR and apply fixes manually.

          ---
          Auto-generated by [Auto Apply Review Suggestions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

          ISSUE_NUMBER=$(gh issue create \
            --title "Manual Review Required: PR #${{ env.PR_NUMBER }}" \
            --label "human-review-needed" \
            --body-file issue_body.md \
            --jq '.number')

          gh pr comment ${{ env.PR_NUMBER }} \
            --body "âŒ **Auto-fix stopped**

          Maximum attempts (5) reached. Human review required.

          Please review Issue #$ISSUE_NUMBER for details.

          ---
          [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Comment on PR (no issues)
        if: steps.extract.outputs.has_critical_issues == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ env.PR_NUMBER }} \
            --body "â„¹ï¸ **Auto-fix: No critical issues found**

            No action needed based on review.

            ---
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
