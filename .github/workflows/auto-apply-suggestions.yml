# Auto Apply Review Suggestions
#
# ãƒˆãƒªã‚¬ãƒ¼:
# - auto-fix ãƒ©ãƒ™ãƒ«ãŒè¿½åŠ ã•ã‚ŒãŸæ™‚
#   (Codex Review ã¾ãŸã¯ Claude Code Review ã§ Critical Issues æ¤œå‡ºæ™‚)
#
# æ©Ÿèƒ½:
# - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ä¿®æ­£å†…å®¹ã‚’æŠ½å‡ºï¼ˆCodex / Claude ä¸¡å¯¾å¿œï¼‰
# - ä¿®æ­£å›žæ•°ã«å¿œã˜ã¦AIã‚’é¸æŠžã—ã¦ä¿®æ­£ã‚’é©ç”¨:
#   - 1å›žç›®: Claude Code
#   - 2å›žç›®: GPT-5.2-Codex medium
#   - 3å›žç›®: GPT-5.2-Codex xhigh
# - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
# - ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦è‡ªå‹•å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼

name: Auto Apply Review Suggestions

on:
  pull_request:
    types: [labeled]
    branches: [main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to apply fixes to'
        required: true
        type: number

concurrency:
  group: auto-fix-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: false

jobs:
  apply-fixes:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Claude/Copilotå®Ÿè¡Œã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    # labeled: auto-fix ãƒ©ãƒ™ãƒ«ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã®ã¿
    # workflow_dispatch: å¸¸ã«å®Ÿè¡Œï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.label.name == 'auto-fix' && github.event.pull_request.head.repo.full_name == github.repository)

    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: write

    steps:
      - name: Resolve PR info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

          PR_JSON=$(gh pr view "$PR_NUMBER" --json headRefName,title)
          HEAD_REF=$(echo "$PR_JSON" | jq -r '.headRefName')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title')
          echo "HEAD_REF=$HEAD_REF" >> $GITHUB_ENV
          echo "PR_TITLE=$PR_TITLE" >> $GITHUB_ENV

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.HEAD_REF }}
          fetch-depth: 0

      - name: Load shared config
        run: |
          source .github/config.env
          echo "CRITICAL_ISSUE_PATTERN=$CRITICAL_ISSUE_PATTERN" >> $GITHUB_ENV
          echo "MAX_FIX_ATTEMPTS=$MAX_FIX_ATTEMPTS" >> $GITHUB_ENV

      - name: Setup AI tools
        uses: ./.github/actions/setup-ai-tools
        with:
          install-claude: 'true'
          install-copilot: 'true'

      - name: Extract review suggestions
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
        run: |
          # Codex Review ã¨ Claude Code Review ã®æœ€æ–°ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
          gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.body | test("GPT-5.2-Codex Review|Claude Code Review"))] | sort_by(.created_at) | last | .body' \
            > review_comments.txt || true

          if [ ! -s review_comments.txt ]; then
            echo "No review comments found"
            echo "has_critical_issues=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          cat review_comments.txt

          # Critical Issues ã®æ¤œå‡ºï¼ˆä¸¡æ–¹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å½¢å¼ã«å¯¾å¿œï¼‰
          if grep -qiE "$CRITICAL_ISSUE_PATTERN" review_comments.txt; then
            echo "has_critical_issues=true" >> $GITHUB_OUTPUT

            # Critical Issues ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
            {
              grep -A 100 -i "Critical Issues" review_comments.txt | grep -E "^\s*(-\s|###\s|\*\*)" || true
              grep -B 2 -A 5 "ðŸ”´" review_comments.txt || true
              grep -B 2 -A 5 -i "severity.*critical" review_comments.txt || true
            } | sort -u > critical_issues.txt

            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æŠ½å‡ºãŒç©ºã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆå…¨ä½“ã‚’ä½¿ç”¨
            if [ ! -s critical_issues.txt ]; then
              cat review_comments.txt > critical_issues.txt
            fi
          else
            echo "has_critical_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if fixable
        id: check-fixable
        if: steps.extract.outputs.has_critical_issues == 'true'
        run: |
          # è‡ªå‹•ä¿®æ­£ä¸å¯èƒ½ãªå•é¡Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
          UNFIXABLE_PATTERNS=(
            "Major refactoring needed"
            "Design change required"
            "External dependency issue"
            "Breaking change required"
            "Needs architectural review"
            "Requires discussion"
          )

          IS_FIXABLE=true

          for PATTERN in "${UNFIXABLE_PATTERNS[@]}"; do
            if grep -iq "$PATTERN" critical_issues.txt; then
              echo "Found unfixable pattern: $PATTERN"
              IS_FIXABLE=false
              break
            fi
          done

          if [ "$IS_FIXABLE" = true ]; then
            echo "is_fixable=true" >> $GITHUB_OUTPUT
            echo "âœ… Issues appear to be fixable"
          else
            echo "is_fixable=false" >> $GITHUB_OUTPUT
            echo "âŒ Issues require manual review"
          fi

      - name: Check fix attempt count
        id: check-count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_LABELS=$(gh pr view ${{ env.PR_NUMBER }} --json labels -q '.labels[].name')

          FIX_COUNT=0
          for i in $(seq 1 "$MAX_FIX_ATTEMPTS"); do
            if echo "$PR_LABELS" | grep -q "auto-fix-attempt-$i"; then
              FIX_COUNT=$i
            fi
          done

          FIX_COUNT=$((FIX_COUNT + 1))
          echo "fix_count=$FIX_COUNT" >> $GITHUB_OUTPUT
          echo "max_fix_attempts=$MAX_FIX_ATTEMPTS" >> $GITHUB_OUTPUT

          if [ $FIX_COUNT -gt "$MAX_FIX_ATTEMPTS" ]; then
            echo "exceeded_max=true" >> $GITHUB_OUTPUT
            echo "::warning::Fix attempts exceeded maximum ($MAX_FIX_ATTEMPTS)"
          else
            echo "exceeded_max=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine AI model
        id: select-model
        env:
          FIX_COUNT: ${{ steps.check-count.outputs.fix_count }}
        run: |
          case "$FIX_COUNT" in
            1)
              MODEL="Claude Code"
              ;;
            2)
              MODEL="GPT-5.2-Codex (medium)"
              ;;
            *)
              MODEL="GPT-5.2-Codex (xhigh)"
              ;;
          esac

          echo "model=$MODEL" >> $GITHUB_OUTPUT
          echo "Using: $MODEL"

      - name: Remove auto-fix label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ env.PR_NUMBER }} \
            --remove-label "auto-fix" 2>/dev/null || true

      - name: Add attempt label
        if: steps.check-count.outputs.exceeded_max == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FIX_COUNT: ${{ steps.check-count.outputs.fix_count }}
        run: |
          ATTEMPT_LABEL="auto-fix-attempt-$FIX_COUNT"
          gh pr edit ${{ env.PR_NUMBER }} \
            --add-label "$ATTEMPT_LABEL"

      - name: Comment on PR (started)
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODEL: ${{ steps.select-model.outputs.model }}
        run: |
          gh pr comment ${{ env.PR_NUMBER }} \
            --body "ðŸ”§ **Auto-fix started (${{ steps.select-model.outputs.model }})**

            Critical issues found in review. Applying automatic fixes...
            Attempt #${{ steps.check-count.outputs.fix_count }}/${{ steps.check-count.outputs.max_fix_attempts }}

            This may take a few minutes.

            ---
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Generate fix prompt
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false'
        env:
          FIX_COUNT: ${{ steps.check-count.outputs.fix_count }}
        run: |
          # 3å›žç›®ä»¥é™ã¯è©¦è¡Œå›žæ•°ã¨ã‚»ãƒ«ãƒ•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’è¿½åŠ 
          ATTEMPT_HEADER=""
          SELF_REVIEW=""
          if [ "$FIX_COUNT" -ge 3 ]; then
            ATTEMPT_HEADER="ã“ã‚Œã¯ç¬¬${FIX_COUNT}å›žç›®ã®ä¿®æ­£è©¦è¡Œã§ã™ã€‚"
            SELF_REVIEW="
          ## Self-Review Checklist
          - ä¿®æ­£ã«ã‚ˆã£ã¦æ–°ãŸãªå•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹
          - ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦é€šéŽã—ã¦ã„ã‚‹ã‹
          - lintã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹
          - type errorãŒãªã„ã‹"
          fi

          cat > fix_prompt.txt << EOF
          ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜ã«åŸºã¥ã„ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
          ${ATTEMPT_HEADER}

          ## Critical Issues to Fix
          $(cat critical_issues.txt)

          ## Instructions
          1. ä¸Šè¨˜ã®Critical Issuesã‚’ä¿®æ­£ã—ã¦ãã ã•ã„
          2. ä¿®æ­£å¾Œã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ (npm run test:run)
          3. ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ãŸå ´åˆã¯ä¿®æ­£ã‚’ç¶šã‘ã¦ãã ã•ã„
          ${SELF_REVIEW}

          ## Requirements
          - Type Safety: anyã‚’ä½¿ç”¨ã—ãªã„
          - Architecture: ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã«å¾“ã† (components -> hooks -> services)
          - Security: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãªã—
          - Performance: é©åˆ‡ãªãƒ¡ãƒ¢åŒ–ã€ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãªã—
          - Testing: æ–°æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆãŒå¿…è¦

          é‡è¦: æ—¥æœ¬èªžã§èª¬æ˜Žã—ã¦ãã ã•ã„ã€‚
          é‡è¦: ã‚³ãƒŸãƒƒãƒˆã¯ä½œæˆã—ãªã„ã§ãã ã•ã„ã€‚å¤‰æ›´ã‚’é©ç”¨ã™ã‚‹ã ã‘ã§ã™ã€‚
          EOF

      - name: Apply fixes via Claude Code
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false' && steps.check-count.outputs.fix_count == '1'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
        run: |
          claude --dangerously-skip-permissions --print "$(cat fix_prompt.txt)" > ai_fix_output.txt 2>&1 || true

      - name: Apply fixes via GPT-5.2-Codex
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false' && steps.check-count.outputs.fix_count >= 2
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.COPILOT_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          copilot -p "$(cat fix_prompt.txt)" \
            --model gpt-5.2-codex \
            --allow-all-tools \
            > ai_fix_output.txt 2>&1 || true

      - name: Post fix output to summary
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false'
        env:
          MODEL: ${{ steps.select-model.outputs.model }}
        run: |
          echo "## ðŸ¤– ${MODEL} Fix Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -200 ai_fix_output.txt >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Run tests
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false'
        id: tests
        run: |
          set -o pipefail
          if npm run test:run -- --no-color 2>&1 | tee test_results.txt; then
            echo "test_status=success" >> $GITHUB_OUTPUT
            echo "test_desc=Tests passed" >> $GITHUB_OUTPUT
          else
            echo "test_status=failure" >> $GITHUB_OUTPUT
            echo "test_desc=Tests failed" >> $GITHUB_OUTPUT
            echo "::warning::Tests failed after auto-fix"
          fi

          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 test_results.txt >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Run lint
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false'
        id: lint
        run: |
          set -o pipefail
          if npm run lint -- --no-color 2>&1 | tee lint_results.txt; then
            echo "lint_status=success" >> $GITHUB_OUTPUT
          else
            echo "lint_status=failure" >> $GITHUB_OUTPUT
            echo "::warning::Lint check failed after auto-fix"
          fi

      - name: Determine commit message
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false'
        id: msg
        env:
          TEST_STATUS: ${{ steps.tests.outputs.test_status }}
          LINT_STATUS: ${{ steps.lint.outputs.lint_status }}
          FIX_COUNT: ${{ steps.check-count.outputs.fix_count }}
          MODEL: ${{ steps.select-model.outputs.model }}
        run: |
          if [ "$TEST_STATUS" != "success" ]; then
            MSG="fix: apply code review suggestions (tests need review) [attempt $FIX_COUNT, $MODEL]"
          elif [ "$LINT_STATUS" != "success" ]; then
            MSG="fix: apply code review suggestions (linting issues) [attempt $FIX_COUNT, $MODEL]"
          else
            MSG="fix: apply code review suggestions [attempt $FIX_COUNT, $MODEL]"
          fi
          echo "commit_message=${MSG}" >> $GITHUB_OUTPUT

      - name: Commit and push fixes
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false'
        id: commit
        uses: ./.github/actions/git-commit-push
        with:
          message: |
            ${{ steps.msg.outputs.commit_message }}

            Auto-generated by GitHub Actions based on review feedback.
          branch: ${{ env.HEAD_REF }}

      - name: Re-trigger auto-fix if needed
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false' && steps.commit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FIX_COUNT: ${{ steps.check-count.outputs.fix_count }}
        run: |
          MAX_FIX_ATTEMPTS="${{ steps.check-count.outputs.max_fix_attempts }}"
          if [ "$FIX_COUNT" -lt "$MAX_FIX_ATTEMPTS" ]; then
            if gh workflow run auto-apply-suggestions.yml \
              -f pr_number=${{ env.PR_NUMBER }} 2>/dev/null; then
              echo "ðŸ”„ Re-triggered auto-fix via workflow_dispatch (attempt #$FIX_COUNT completed)"
            else
              echo "::warning::workflow_dispatch re-trigger not available, adding auto-fix label as fallback"
              gh pr edit ${{ env.PR_NUMBER }} --add-label "auto-fix" || true
            fi
          fi

      - name: Comment on PR (success)
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false' && steps.commit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_STATUS: ${{ steps.tests.outputs.test_status }}
          LINT_STATUS: ${{ steps.lint.outputs.lint_status }}
          FIX_COUNT: ${{ steps.check-count.outputs.fix_count }}
          MODEL: ${{ steps.select-model.outputs.model }}
        run: |
          STATUS_EMOJI="âœ…"
          if [ "$TEST_STATUS" != "success" ] || [ "$LINT_STATUS" != "success" ]; then
            STATUS_EMOJI="âš ï¸"
          fi

          gh pr comment ${{ env.PR_NUMBER }} \
            --body "$STATUS_EMOJI **Auto-fix completed ($MODEL)**

            Fixes have been applied and pushed.

            - Attempt: $FIX_COUNT/${{ steps.check-count.outputs.max_fix_attempts }}
            - Tests: $TEST_STATUS
            - Lint: $LINT_STATUS

            The PR update will trigger an automatic re-review.

            ---
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Comment on PR (no changes)
        if: steps.extract.outputs.has_critical_issues == 'true' && steps.check-count.outputs.exceeded_max == 'false' && steps.commit.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FIX_COUNT: ${{ steps.check-count.outputs.fix_count }}
          MODEL: ${{ steps.select-model.outputs.model }}
        run: |
          gh pr comment ${{ env.PR_NUMBER }} \
            --body "â„¹ï¸ **Auto-fix: No changes made ($MODEL)**

            AI reviewed the issues but did not make any code changes.
            This might mean:
            - The issues require manual review
            - The changes are already in place
            - Further clarification is needed

            Please review the issues manually.

            ---
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Request human review (unfixable)
        if: steps.check-fixable.outputs.is_fixable == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_COMMENT=$(cat review_comments.txt)

          cat > issue_body.md << EOF
          ## Manual Review Required - Unfixable Issues

          ### Pull Request
          - PR: #${{ env.PR_NUMBER }}
          - Title: ${{ env.PR_TITLE }}

          ### Review Feedback
          $REVIEW_COMMENT

          ### Why Manual Review?
          The automated review detected issues that require human intervention:
          - Major refactoring needed
          - Design change required
          - External dependency issue
          - Breaking change required
          - Architectural review needed
          - Requires discussion

          ### Next Steps
          Please review the PR and apply fixes manually.
          Once fixed, trigger a new Codex review by pushing changes or adding the `needs-review` label.

          ---
          Auto-generated by [Auto Apply Review Suggestions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

          ISSUE_NUMBER=$(gh issue create \
            --title "Manual Review Required: PR #${{ env.PR_NUMBER }}" \
            --label "human-review-needed" \
            --body-file issue_body.md \
            --jq '.number')

          gh pr edit ${{ env.PR_NUMBER }} \
            --remove-label "auto-fix"

          gh pr comment ${{ env.PR_NUMBER }} \
            --body "âŒ **Auto-fix: Issues require manual review**

            The detected issues need human intervention.

          Please review Issue #$ISSUE_NUMBER for details.

          ---
          [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Request human review (exceeded attempts)
        if: steps.check-count.outputs.exceeded_max == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # äººé–“ä»‹å…¥ä¾é ¼ã®Issueã‚’ä½œæˆ
          REVIEW_COMMENT=$(cat review_comments.txt)

          cat > issue_body.md << EOF
          ## Manual Review Required

          Auto-fix attempts have exceeded the maximum.

          ### Pull Request
          - PR: #${{ env.PR_NUMBER }}
          - Title: ${{ env.PR_TITLE }}

          ### Review Feedback
          $REVIEW_COMMENT

          ### Next Steps
          Please review the PR and apply fixes manually.

          ---
          Auto-generated by [Auto Apply Review Suggestions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

          ISSUE_NUMBER=$(gh issue create \
            --title "Manual Review Required: PR #${{ env.PR_NUMBER }}" \
            --label "human-review-needed" \
            --body-file issue_body.md \
            --jq '.number')

          gh pr comment ${{ env.PR_NUMBER }} \
            --body "âŒ **Auto-fix stopped**

          Maximum attempts reached. Human review required.

          Please review Issue #$ISSUE_NUMBER for details.

          ---
          [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Comment on PR (no issues)
        if: steps.extract.outputs.has_critical_issues == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ env.PR_NUMBER }} \
            --body "â„¹ï¸ **Auto-fix: No critical issues found**

            No action needed based on review.

            ---
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Clean up work files
        if: always()
        run: |
          rm -f ai_fix_output.txt fix_prompt.txt critical_issues.txt
          rm -f review_comments.txt test_results.txt lint_results.txt
