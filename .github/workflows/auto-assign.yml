# Auto Code Review (Claude Code)
#
# Features:
# - Automatically runs Claude Code review on PR creation
# - Uses code-review skill
# - Posts review results as PR comment
#
# Configuration:
# - Set ANTHROPIC_API_KEY or ZAI_API_KEY

name: Auto Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

# åŒã˜PRã¸ã®é‡è¤‡å®Ÿè¡Œã‚’é˜²æ­¢
concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  claude-review:
    # Skip draft PRs
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      actions: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
      
      - name: Get changed files
        id: changed
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx|py)$' | head -20 | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT
      
      - name: Run Claude Code Review
        if: steps.changed.outputs.files != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
        run: |
          echo "Reviewing changed files..."
          
          # Use code-review skill
          claude --print "Review the following files for quality, performance, and security: ${{ steps.changed.outputs.files }}" > review_output.txt 2>&1 || true
          
          echo "::group::Review Output"
          cat review_output.txt
          echo "::endgroup::"
      
      - name: Comment on PR
        if: steps.changed.outputs.files != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          {
            echo "## ðŸ¤– Claude Code Review"
            echo ""
            echo "Changed files: \`${{ steps.changed.outputs.files }}\`"
            echo ""
            echo "<details>"
            echo "<summary>Review Results</summary>"
            echo ""
            echo '```'
            head -100 review_output.txt
            echo '```'
            echo ""
            echo "</details>"
            echo ""
            echo "---"
            echo "*Auto-generated by Claude Code*"
          } > /tmp/review_comment.md

          gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/review_comment.md

      - name: Submit formal PR review
        if: steps.changed.outputs.files != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          if [ ! -f review_output.txt ]; then
            echo "No review output, skipping formal review"
            exit 0
          fi

          if grep -qiE "(Critical Issues|REQUEST_CHANGES|ðŸ”´|severity.*critical)" review_output.txt; then
            gh pr review "$PR_NUMBER" --request-changes \
              --body "Claude Code review detected critical issues. See the review comment for details."
          else
            gh pr review "$PR_NUMBER" --approve \
              --body "Claude Code review passed. No critical issues found."
          fi

      - name: Check for critical issues
        if: steps.changed.outputs.files != ''
        id: check-issues
        run: |
          if [ ! -f review_output.txt ]; then
            echo "needs_fix=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Critical Issues / REQUEST_CHANGES / ðŸ”´ ã®ã„ãšã‚Œã‹ãŒã‚ã‚Œã°ä¿®æ­£ãŒå¿…è¦
          if grep -qiE "(Critical Issues|REQUEST_CHANGES|ðŸ”´|severity.*critical)" review_output.txt; then
            echo "needs_fix=true" >> $GITHUB_OUTPUT
            echo "Critical issues detected in Claude review"
          else
            echo "needs_fix=false" >> $GITHUB_OUTPUT
            echo "No critical issues found"
          fi

      - name: Ensure labels exist
        if: steps.changed.outputs.files != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create "claude-reviewed" --description "Claude Code Review completed" --color "6f42c1" 2>/dev/null || true
          gh label create "auto-fix" --description "Auto-fix triggered by review" --color "d93f0b" 2>/dev/null || true

      - name: Trigger auto-fix workflow
        if: steps.check-issues.outputs.needs_fix == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ©ãƒ™ãƒ«è¿½åŠ ï¼ˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ç”¨ï¼‰
          gh pr edit ${{ github.event.pull_request.number }} \
            --add-label "auto-fix" \
            --add-label "claude-reviewed"

          # workflow_dispatch ã§è‡ªå‹•ä¿®æ­£ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•
          # Note: GITHUB_TOKEN ã§ã®ãƒ©ãƒ™ãƒ«è¿½åŠ ã¯ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ãªã„ãŸã‚
          # workflow_dispatch ã‚’ä½¿ç”¨ï¼ˆã“ã‚Œã¯ä¾‹å¤–çš„ã«ãƒˆãƒªã‚¬ãƒ¼å¯èƒ½ï¼‰
          # Note: workflow_dispatch ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©ã‚’å‚ç…§ã™ã‚‹ãŸã‚
          # åˆå›žãƒžãƒ¼ã‚¸å¾Œã‹ã‚‰æœ‰åŠ¹ã«ãªã‚‹
          if gh workflow run auto-apply-suggestions.yml \
            -f pr_number=${{ github.event.pull_request.number }} 2>/dev/null; then
            echo "Triggered auto-fix workflow via workflow_dispatch"
          else
            echo "::warning::workflow_dispatch trigger not available yet (requires merge to main)"
            echo "auto-fix label has been added for manual triggering"
          fi

      - name: Add reviewed label (no issues)
        if: steps.changed.outputs.files != '' && steps.check-issues.outputs.needs_fix == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} \
            --add-label "claude-reviewed"

      - name: No files to review
        if: steps.changed.outputs.files == ''
        run: echo "No files to review"
