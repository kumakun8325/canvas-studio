# GitHub Project Integration
#
# Features:
# - Automatically adds Issues/PRs to GitHub Project
# - Updates status based on labels
# - Adds 'done' label to Issues when PR is merged

name: Project Integration

on:
  issues:
    types: [opened, labeled]
  pull_request:
    types: [opened, closed, labeled]

permissions:
  issues: write
  pull-requests: read
  contents: read

env:
  PROJECT_URL: ${{ vars.PROJECT_URL }}

jobs:
  add-to-project:
    if: github.event.action == 'opened' && vars.PROJECT_URL != ''
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check PAT availability
        id: check
        run: |
          if [ -z "${{ secrets.ADD_TO_PROJECT_PAT }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "ADD_TO_PROJECT_PAT is not set. Skipping."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Add to Project
        if: steps.check.outputs.skip != 'true'
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}

  update-status:
    if: github.event.action == 'labeled'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Update Project Status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const label = context.payload.label.name;
            const statusMap = {
              'planning': 'Planning',
              'in-progress': 'In Progress',
              'ready-for-review': 'Review',
              'done': 'Done'
            };
            
            if (statusMap[label]) {
              console.log(`Status updated to: ${statusMap[label]}`);
              // Note: Actual status update requires GraphQL API
            }

  close-issue-on-merge:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Add done label to related Issue
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const issueMatch = prBody.match(/(?:closes|fixes|resolves)\s+#(\d+)/i);
            
            if (issueMatch) {
              const issueNumber = parseInt(issueMatch[1]);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['done']
              });
              console.log(`Added 'done' label to Issue #${issueNumber}`);
            }
