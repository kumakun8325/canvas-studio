# Automated Test Execution
#
# Features:
# - Runs tests on PR creation/update
# - Runs tests on push to main
# - Blocks merge on test failure (with Branch Protection)
# - Quality gates: coverage (80%), complexity, security

name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint (parallel)
        id: lint
        continue-on-error: true
        run: npm run lint

      - name: Run type check (parallel)
        id: typecheck
        continue-on-error: true
        run: npx tsc --noEmit

      - name: Run unit tests with coverage (parallel)
        id: test
        run: npm run test:coverage

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Summarize coverage thresholds
        id: coverage-threshold
        if: always()
        run: |
          # Vitestはcoverage.jsonまたはcoverage-final.jsonを出力
          if [ -f "coverage/coverage-final.json" ]; then
            COVERAGE_FILE="coverage/coverage-final.json"
          elif [ -f "coverage/coverage.json" ]; then
            COVERAGE_FILE="coverage/coverage.json"
          else
            echo "::warning::Coverage JSON file not found."
            echo "coverage_summary_status=not_found" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 各メトリクスを抽出
          TOTAL=$(jq -r '.total' "$COVERAGE_FILE" 2>/dev/null || echo "{}")
          STATEMENTS=$(echo "$TOTAL" | jq -r '.lines.pct // .statements.pct // .line.pct // 0' | sed 's/%//g')
          BRANCHES=$(echo "$TOTAL" | jq -r '.branches.pct // .branch.pct // 0' | sed 's/%//g')
          FUNCTIONS=$(echo "$TOTAL" | jq -r '.functions.pct // .function.pct // 0' | sed 's/%//g')
          LINES=$(echo "$TOTAL" | jq -r '.lines.pct // .line.pct // 0' | sed 's/%//g')

          # パーセントを数値に変換
          STATEMENTS=${STATEMENTS:-0}
          BRANCHES=${BRANCHES:-0}
          FUNCTIONS=${FUNCTIONS:-0}
          LINES=${LINES:-0}

          echo "Coverage Summary:" >> $GITHUB_STEP_SUMMARY
          echo "- Statements: ${STATEMENTS}% (threshold: 80%)" >> $GITHUB_STEP_SUMMARY
          echo "- Branches: ${BRANCHES}% (threshold: 70%)" >> $GITHUB_STEP_SUMMARY
          echo "- Functions: ${FUNCTIONS}% (threshold: 90%)" >> $GITHUB_STEP_SUMMARY
          echo "- Lines: ${LINES}% (threshold: 80%)" >> $GITHUB_STEP_SUMMARY

          # 閾値チェック
          FAILED=false

          if (( STATEMENTS < 80 )); then
            echo "::error::Statements coverage (${STATEMENTS}%) below threshold (80%)"
            FAILED=true
          fi

          if (( BRANCHES < 70 )); then
            echo "::error::Branches coverage (${BRANCHES}%) below threshold (70%)"
            FAILED=true
          fi

          if (( FUNCTIONS < 90 )); then
            echo "::error::Functions coverage (${FUNCTIONS}%) below threshold (90%)"
            FAILED=true
          fi

          if (( LINES < 80 )); then
            echo "::error::Lines coverage (${LINES}%) below threshold (80%)"
            FAILED=true
          fi

          if [ "$FAILED" = true ]; then
            echo "coverage_summary_status=failure" >> $GITHUB_OUTPUT
          else
            echo "coverage_summary_status=success" >> $GITHUB_OUTPUT
          fi

      - name: Check security vulnerabilities
        id: security
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Quality gate summary
        if: always()
        run: |
          echo "## Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ steps.lint.outcome == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ steps.typecheck.outcome == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ steps.test.outcome == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ steps.coverage-threshold.outcome == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ steps.security.outcome == 'success' && '✅ Pass' || '⚠️ Review needed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check all quality gates
        if: always()
        run: |
          FAILED=false

          if [ "${{ steps.lint.outcome }}" != "success" ]; then
            echo "::error::Lint check failed"
            FAILED=true
          fi

          if [ "${{ steps.typecheck.outcome }}" != "success" ]; then
            echo "::error::Type check failed"
            FAILED=true
          fi

          if [ "${{ steps.test.outcome }}" != "success" ]; then
            echo "::error::Tests failed"
            FAILED=true
          fi

          if [ "${{ steps.coverage-threshold.outputs.coverage_summary_status }}" == "failure" ]; then
            echo "::error::Coverage thresholds not met"
            FAILED=true
          fi

          if [ "$FAILED" = true ]; then
            exit 1
          fi

          if [ "${{ steps.security.outcome }}" != "success" ]; then
            echo "::warning::Security vulnerabilities found. Please review."
          fi
          echo "All quality gates passed"
