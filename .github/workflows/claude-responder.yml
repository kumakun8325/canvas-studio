# Claude Code GitHub Actions Integration
#
# Trigger methods:
# 1. @claude mention in Issue/PR comments
# 2. Label 'claude-auto' or 'claude-tdd' on Issue
#
# Setup:
# 1. Repository Settings → Secrets and variables → Actions
# 2. Add the following Secrets:
#    - ANTHROPIC_API_KEY: Anthropic API key (or use ZAI_API_KEY)
# 3. Add the following Variables (optional):
#    - ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic (for GLM)

name: Claude Code Responder

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, labeled]

concurrency:
  group: claude-respond-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  determine-mode:
    # Run if @claude mentioned OR claude-auto/claude-tdd label added
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'labeled' &&
       (github.event.label.name == 'claude-auto' || github.event.label.name == 'claude-tdd'))
    runs-on: ubuntu-latest
    outputs:
      mode: ${{ steps.mode.outputs.mode }}
      issue_number: ${{ steps.mode.outputs.issue_number }}
    steps:
      - name: Determine execution mode
        id: mode
        run: |
          if [ "${{ github.event.action }}" == "labeled" ]; then
            if [ "${{ github.event.label.name }}" == "claude-tdd" ]; then
              echo "mode=tdd" >> $GITHUB_OUTPUT
            else
              echo "mode=auto" >> $GITHUB_OUTPUT
            fi
          else
            echo "mode=auto" >> $GITHUB_OUTPUT
          fi
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

  implement:
    needs: determine-mode
    uses: ./.github/workflows/claude-implement.yml
    with:
      issue-number: ${{ needs.determine-mode.outputs.issue_number }}
      mode: ${{ needs.determine-mode.outputs.mode }}
      run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    secrets:
      anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
