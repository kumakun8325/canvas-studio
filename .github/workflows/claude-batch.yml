# Claude Batch Implementation - è¤‡æ•°Issueã®ä¸¦åˆ—å®Ÿè£…
#
# ä½¿ã„æ–¹:
# 1. Actions ã‚¿ãƒ– â†’ Claude Batch Implementation
# 2. Run workflow ã‚’ã‚¯ãƒªãƒƒã‚¯
# 3. issue_numbers ã« "5,6,7" ã®ã‚ˆã†ã«ã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šã§å…¥åŠ›
# 4. mode ã‚’é¸æŠž (auto ã¾ãŸã¯ tdd)
# 5. Run workflow å®Ÿè¡Œ
#
# ä¸¦åˆ—å®Ÿè¡Œã®ä»•çµ„ã¿:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  workflow_dispatch                       â”‚
# â”‚  issue_numbers: "5,6,7"                 â”‚
# â”‚  mode: auto                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                     â†“
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  prepare job                            â”‚
# â”‚  â†’ matrix: {issue_number: ["5","6","7"]}â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                     â†“
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Issue #5 â”‚ Issue #6 â”‚ Issue #7 â”‚  â† ä¸¦åˆ—å®Ÿè¡Œï¼
# â”‚ Claude   â”‚ Claude   â”‚ Claude   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

name: Claude Batch Implementation

on:
  workflow_dispatch:
    inputs:
      issue_numbers:
        description: 'Issue numbers (comma-separated, e.g., "1,2,3")'
        required: true
        type: string
      mode:
        description: 'Execution mode'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - tdd
      max_parallel:
        description: 'Maximum parallel jobs (1-10)'
        required: false
        default: '5'
        type: string

jobs:
  # 1. Issueç•ªå·ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦matrixã‚’ç”Ÿæˆ
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      issue_count: ${{ steps.set-matrix.outputs.issue_count }}
    steps:
      - name: Generate matrix from issue numbers
        id: set-matrix
        run: |
          # "1,2,3" â†’ ["1","2","3"]
          ISSUES='${{ inputs.issue_numbers }}'

          # Remove spaces and validate
          ISSUES=$(echo "$ISSUES" | tr -d ' ')

          if [ -z "$ISSUES" ]; then
            echo "Error: No issue numbers provided"
            exit 1
          fi

          # Generate matrix JSON (compact for single-line GITHUB_OUTPUT)
          MATRIX=$(echo "$ISSUES" | tr ',' '\n' | jq -R . | jq -sc '{ issue_number: . }')
          ISSUE_COUNT=$(echo "$ISSUES" | tr ',' '\n' | wc -l | tr -d ' ')

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "issue_count=$ISSUE_COUNT" >> $GITHUB_OUTPUT
          echo "Generated matrix for $ISSUE_COUNT issues: $MATRIX"

      - name: Summary
        run: |
          echo "## ðŸš€ Batch Implementation Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issues**: ${{ inputs.issue_numbers }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: ${{ inputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Max Parallel**: ${{ inputs.max_parallel }}" >> $GITHUB_STEP_SUMMARY

  # 2. ä¸¦åˆ—å®Ÿè£… (reusable workflow)
  implement:
    needs: prepare
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      max-parallel: ${{ fromJson(inputs.max_parallel || '5') }}
      fail-fast: false
    uses: ./.github/workflows/claude-implement.yml
    with:
      issue-number: ${{ matrix.issue_number }}
      mode: ${{ inputs.mode }}
      batch-context: ${{ inputs.issue_numbers }}
      run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    secrets:
      anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}

  # 3. å®Œäº†ã‚µãƒžãƒªãƒ¼
  summary:
    needs: [prepare, implement]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸŽ‰ Batch Implementation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issues processed**: ${{ inputs.issue_numbers }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: ${{ inputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check individual job results above for status of each issue." >> $GITHUB_STEP_SUMMARY
