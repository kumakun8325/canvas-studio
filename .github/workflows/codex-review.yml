# GPT-5.2-Codex „Å´„Çà„ÇãËá™Âãï„Ç≥„Éº„Éâ„É¨„Éì„É•„Éº
#
# „Éà„É™„Ç¨„Éº:
# - PR„Ååopen„Åï„Çå„ÅüÊôÇ
# - PR„ÅåÊõ¥Êñ∞„Åï„Çå„ÅüÊôÇ
#
# Ê©üËÉΩ:
# - Â§âÊõ¥„Éï„Ç°„Ç§„É´„ÇíGPT-5.2-Codex (medium) „Åß„É¨„Éì„É•„Éº
# - „É¨„Éì„É•„ÉºÁµêÊûú„ÇíPR„Ç≥„É°„É≥„Éà„Å®„Åó„Å¶ÊäïÁ®ø
# - ÈáçÂ§ß„Å™ÂïèÈ°å„Åå„ÅÇ„Çå„Å∞Ë≠¶Âëä

name: Codex Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches: [main]

# Âêå„ÅòPR„Å∏„ÅÆÈáçË§áÂÆüË°å„ÇíÈò≤Ê≠¢
concurrency:
  group: codex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Copilot„É¨„Éì„É•„Éº„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„Éà
    # „Åô„Åπ„Å¶„ÅÆPR„Çí„É¨„Éì„É•„ÉºÔºàskip-codex-review „É©„Éô„É´„Åß„Ç™„Éó„Éà„Ç¢„Ç¶„ÉàÂèØËÉΩÔºâ
    if: "!contains(github.event.pull_request.labels.*.name, 'skip-codex-review') && github.event.pull_request.draft == false"

    permissions:
      contents: read
      pull-requests: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Load shared config
        run: |
          source .github/config.env
          echo "CRITICAL_ISSUE_PATTERN=$CRITICAL_ISSUE_PATTERN" >> $GITHUB_ENV

      - name: Setup AI tools
        id: setup
        uses: ./.github/actions/setup-ai-tools
        with:
          install-copilot: 'true'
          install-deps: 'false'

      - name: Get changed files
        id: changed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # PR„ÅÆÂ§âÊõ¥„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÂèñÂæó
          FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only | grep -E '\.(ts|tsx|js|jsx)$' || true)

          if [ -z "$FILES" ]; then
            echo "No TypeScript/JavaScript files changed"
            echo "has_files=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$FILES"
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "$FILES" > changed_files.txt
          fi

      - name: Prepare review context
        if: steps.changed.outputs.has_files == 'true'
        env:
          PR_NUMBER_VAL: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # „É¨„Éì„É•„ÉºÁî®„ÅÆ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÊ∫ñÂÇô
          {
            echo "# Code Review Request"
            echo ""
            echo "## PR Information"
            echo "- PR #${PR_NUMBER_VAL}"
            echo "- Title: ${PR_TITLE}"
            echo ""
            echo "## Changed Files"
            cat changed_files.txt
            echo ""
            echo "## Review Guidelines"
            echo "Based on project rules in .claude/rules/:"
            echo ""
            echo "### Check Points"
            echo "1. **Type Safety**: No \`any\`, proper type definitions"
            echo "2. **Architecture**: Follows layer structure (components -> hooks -> services)"
            echo "3. **Security**: No hardcoded secrets, proper input validation"
            echo "4. **Performance**: Proper memoization, no unnecessary re-renders"
            echo "5. **Testing**: Tests exist for new functionality"
            echo ""
            echo "## Output Format"
            echo ""
            echo "### JSON Format (machine-readable)"
            echo "Provide review in the following JSON format first:"
            echo "\`\`\`json"
            echo "{"
            echo "  \"verdict\": \"APPROVE|REQUEST_CHANGES|COMMENT\","
            echo "  \"summary\": \"Overall assessment (1-2 sentences)\","
            echo "  \"critical_issues\": ["
            echo "    {"
            echo "      \"file\": \"path/to/file.ts\","
            echo "      \"line\": 123,"
            echo "      \"description\": \"Issue description\","
            echo "      \"severity\": \"Critical|Major|Minor\","
            echo "      \"fixable\": true"
            echo "    }"
            echo "  ],"
            echo "  \"suggestions\": ["
            echo "    {"
            echo "      \"file\": \"path/to/file.ts\","
            echo "      \"description\": \"Suggestion description\""
            echo "    }"
            echo "  ],"
            echo "  \"scores\": {"
            echo "    \"type_safety\": 5,"
            echo "    \"architecture\": 5,"
            echo "    \"performance\": 5,"
            echo "    \"security\": 5,"
            echo "    \"testing\": 5"
            echo "  }"
            echo "}"
            echo "\`\`\`"
            echo ""
            echo "### Human-Readable Format (comment)"
            echo "Then provide a human-readable summary in Japanese with:"
            echo "- **Summary**: Overall assessment (1-2 sentences)"
            echo "- **Critical Issues**: Must fix before merge (if any)"
            echo "- **Suggestions**: Nice-to-have improvements (if any)"
            echo "- **Verdict**: APPROVE / REQUEST_CHANGES / COMMENT"
          } > review_prompt.txt

      - name: Run Codex Review
        if: steps.changed.outputs.has_files == 'true'
        id: review
        env:
          # Copilot CLI „ÅØ COPILOT_GITHUB_TOKEN ‚Üí GH_TOKEN ‚Üí GITHUB_TOKEN „ÅÆÈ†Ü„ÅßË™çË®º„ÇíË©¶Ë°å
          # CopilotÁî®PAT„Åå„ÅÇ„Çå„Å∞„Åù„Å°„Çâ„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞„Éá„Éï„Ç©„É´„Éà„Éà„Éº„ÇØ„É≥„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.COPILOT_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Copilot CLI„Åß„É¨„Éì„É•„ÉºÂÆüË°å
          REVIEW_AVAILABLE=true

          if [ -z "${COPILOT_GITHUB_TOKEN:-}" ]; then
            REVIEW_AVAILABLE=false
            echo "::warning::No Copilot authentication token available"
            echo "Copilot CLI requires a token with Copilot access." > review_result.md
            echo "Set COPILOT_TOKEN or COPILOT_GITHUB_TOKEN secret." >> review_result.md
          elif ! command -v copilot &> /dev/null; then
            REVIEW_AVAILABLE=false
            echo "::warning::Copilot CLI is not available"
            echo "Copilot CLI not found. Setup may have failed." > review_result.md
          else
            if ! copilot -p "$(cat review_prompt.txt)" \
              --model gpt-5.2-codex \
              > review_result.md 2>&1; then
              REVIEW_AVAILABLE=false
              echo "::warning::Codex review execution failed"
            fi
          fi

          if [ ! -s review_result.md ]; then
            REVIEW_AVAILABLE=false
            echo "Codex review could not be completed. Please review manually." > review_result.md
          fi

          echo "review_available=$REVIEW_AVAILABLE" >> $GITHUB_OUTPUT

      - name: Post review comment
        if: steps.changed.outputs.has_files == 'true' && steps.review.outputs.review_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          {
            echo "## ü§ñ GPT-5.2-Codex Review"
            echo ""
            echo "---"
            echo ""
            cat review_result.md
            echo ""
            echo "---"
            echo "> üîç Automated review by GPT-5.2-Codex (medium)"
            echo "> [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } > /tmp/codex_review_comment.md

          gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/codex_review_comment.md

      - name: Submit formal PR review
        if: steps.changed.outputs.has_files == 'true' && steps.review.outputs.review_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          if grep -qiE "$CRITICAL_ISSUE_PATTERN" review_result.md; then
            VERDICT="REQUEST_CHANGES"
          else
            VERDICT="APPROVE"
          fi

          if [ "$VERDICT" == "REQUEST_CHANGES" ]; then
            gh pr review "$PR_NUMBER" --request-changes \
              --body "GPT-5.2-Codex review detected critical issues. See the review comment for details."
          else
            gh pr review "$PR_NUMBER" --approve \
              --body "GPT-5.2-Codex review passed. No critical issues found."
          fi

      - name: Post skip message
        if: steps.changed.outputs.has_files == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ü§ñ GPT-5.2-Codex Review

            No TypeScript/JavaScript files were changed in this PR. Skipping automated review.

            ---
            > [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Check if auto-fix needed
        if: steps.changed.outputs.has_files == 'true' && steps.review.outputs.review_available == 'true'
        id: check-fix
        run: |
          if grep -qiE "$CRITICAL_ISSUE_PATTERN" review_result.md; then
            echo "needs_fix=true" >> $GITHUB_OUTPUT
            echo "Critical issues found, will trigger auto-fix"
          else
            echo "needs_fix=false" >> $GITHUB_OUTPUT
            echo "No critical issues, no auto-fix needed"
          fi

      - name: Add labels and trigger auto-fix
        if: steps.review.outputs.review_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEEDS_FIX: ${{ steps.check-fix.outputs.needs_fix }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} \
            --add-label "codex-reviewed"

          if [ "$NEEDS_FIX" == "true" ]; then
            # „É©„Éô„É´ËøΩÂä†Ôºà„Éà„É©„ÉÉ„Ç≠„É≥„Ç∞Áî®Ôºâ
            gh pr edit ${{ github.event.pull_request.number }} \
              --add-label "auto-fix"

            # workflow_dispatch „ÅßËá™Âãï‰øÆÊ≠£„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíËµ∑Âãï
            if gh workflow run auto-apply-suggestions.yml \
              -f pr_number=${{ github.event.pull_request.number }} 2>/dev/null; then
              echo "‚úÖ Triggered auto-fix workflow via workflow_dispatch"
            else
              echo "::warning::workflow_dispatch trigger not available yet (requires merge to main)"
            fi
          fi

      - name: Check merge conditions
        if: steps.check-fix.outputs.needs_fix == 'false' && steps.review.outputs.review_available == 'true'
        id: merge-check
        uses: ./.github/actions/check-pr-mergeable
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          pr-number: ${{ github.event.pull_request.number }}
          merge-if-ready: 'true'
          merge-subject: 'Auto-merge after Codex review: ${{ github.event.pull_request.title }}'

      - name: Comment on pending merge
        if: steps.merge-check.outputs.can_merge == 'false' && steps.merge-check.outputs.reason != 'blocking_reviews'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REASON: ${{ steps.merge-check.outputs.reason }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          case "$REASON" in
            failed_checks)
              MSG="Codex review approved, but some checks have not passed yet. Auto-merge will be triggered once all checks pass." ;;
            pending_checks)
              MSG="Codex review approved, but some checks are still running. Auto-merge will be triggered once all checks complete." ;;
            not_mergeable)
              MSG="Codex review approved, but PR has conflicts that need to be resolved. Please resolve conflicts and merge manually." ;;
          esac
          gh pr comment $PR_NUMBER \
            --body "‚ÑπÔ∏è **Auto-merge pending**

          $MSG

          ---
          [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
