# GPT-5.2-Codex „Å´„Çà„ÇãËá™Âãï„Ç≥„Éº„Éâ„É¨„Éì„É•„Éº
#
# „Éà„É™„Ç¨„Éº:
# - PR„Ååopen„Åï„Çå„ÅüÊôÇ
# - PR„ÅåÊõ¥Êñ∞„Åï„Çå„ÅüÊôÇ
#
# Ê©üËÉΩ:
# - Â§âÊõ¥„Éï„Ç°„Ç§„É´„ÇíGPT-5.2-Codex (medium) „Åß„É¨„Éì„É•„Éº
# - „É¨„Éì„É•„ÉºÁµêÊûú„ÇíPR„Ç≥„É°„É≥„Éà„Å®„Åó„Å¶ÊäïÁ®ø
# - ÈáçÂ§ß„Å™ÂïèÈ°å„Åå„ÅÇ„Çå„Å∞Ë≠¶Âëä

name: Codex Review

on:
  pull_request:
    types: [opened, synchronize, labeled]
    branches: [main]

# Âêå„ÅòPR„Å∏„ÅÆÈáçË§áÂÆüË°å„ÇíÈò≤Ê≠¢
concurrency:
  group: codex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Copilot„É¨„Éì„É•„Éº„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„Éà
    # „Åô„Åπ„Å¶„ÅÆPR„Çí„É¨„Éì„É•„ÉºÔºàskip-codex-review „É©„Éô„É´„Åß„Ç™„Éó„Éà„Ç¢„Ç¶„ÉàÂèØËÉΩÔºâ
    if: "!contains(github.event.pull_request.labels.*.name, 'skip-codex-review')"

    permissions:
      contents: read
      pull-requests: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install GitHub Copilot CLI
        id: install-copilot
        continue-on-error: true
        run: npm install -g @github/copilot

      - name: Get changed files
        id: changed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # PR„ÅÆÂ§âÊõ¥„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÂèñÂæó
          FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only | grep -E '\.(ts|tsx|js|jsx)$' || true)

          if [ -z "$FILES" ]; then
            echo "No TypeScript/JavaScript files changed"
            echo "has_files=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$FILES"
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "$FILES" > changed_files.txt
          fi

      - name: Prepare review context
        if: steps.changed.outputs.has_files == 'true'
        run: |
          # „É¨„Éì„É•„ÉºÁî®„ÅÆ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÊ∫ñÂÇô
          {
            echo "# Code Review Request"
            echo ""
            echo "## PR Information"
            echo "- PR #${{ github.event.pull_request.number }}"
            echo "- Title: ${{ github.event.pull_request.title }}"
            echo ""
            echo "## Changed Files"
            cat changed_files.txt
            echo ""
            echo "## Review Guidelines"
            echo "Based on project rules in .claude/rules/:"
            echo ""
            echo "### Check Points"
            echo "1. **Type Safety**: No \`any\`, proper type definitions"
            echo "2. **Architecture**: Follows layer structure (components -> hooks -> services)"
            echo "3. **Security**: No hardcoded secrets, proper input validation"
            echo "4. **Performance**: Proper memoization, no unnecessary re-renders"
            echo "5. **Testing**: Tests exist for new functionality"
            echo ""
            echo "## Output Format"
            echo ""
            echo "### JSON Format (machine-readable)"
            echo "Provide review in the following JSON format first:"
            echo "\`\`\`json"
            echo "{"
            echo "  \"verdict\": \"APPROVE|REQUEST_CHANGES|COMMENT\","
            echo "  \"summary\": \"Overall assessment (1-2 sentences)\","
            echo "  \"critical_issues\": ["
            echo "    {"
            echo "      \"file\": \"path/to/file.ts\","
            echo "      \"line\": 123,"
            echo "      \"description\": \"Issue description\","
            echo "      \"severity\": \"Critical|Major|Minor\","
            echo "      \"fixable\": true"
            echo "    }"
            echo "  ],"
            echo "  \"suggestions\": ["
            echo "    {"
            echo "      \"file\": \"path/to/file.ts\","
            echo "      \"description\": \"Suggestion description\""
            echo "    }"
            echo "  ],"
            echo "  \"scores\": {"
            echo "    \"type_safety\": 5,"
            echo "    \"architecture\": 5,"
            echo "    \"performance\": 5,"
            echo "    \"security\": 5,"
            echo "    \"testing\": 5"
            echo "  }"
            echo "}"
            echo "\`\`\`"
            echo ""
            echo "### Human-Readable Format (comment)"
            echo "Then provide a human-readable summary in Japanese with:"
            echo "- **Summary**: Overall assessment (1-2 sentences)"
            echo "- **Critical Issues**: Must fix before merge (if any)"
            echo "- **Suggestions**: Nice-to-have improvements (if any)"
            echo "- **Verdict**: APPROVE / REQUEST_CHANGES / COMMENT"
          } > review_prompt.txt

      - name: Run Codex Review
        if: steps.changed.outputs.has_files == 'true'
        id: review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.COPILOT_GITHUB_TOKEN }}
        run: |
          # Copilot CLI„Åß„É¨„Éì„É•„ÉºÂÆüË°å
          # Note: GitHub ActionsÁí∞Â¢É„Åß„ÅØCopilot„Ç¢„ÇØ„Çª„ÇπÊ®©„ÅÆ„ÅÇ„Çã„Éà„Éº„ÇØ„É≥„ÅåÂøÖË¶Å
          REVIEW_AVAILABLE=true

          if [ -z "${COPILOT_TOKEN:-}" ]; then
            REVIEW_AVAILABLE=false
            echo "‚ö†Ô∏è COPILOT_TOKEN is not set." > review_result.md
            echo "" >> review_result.md
            echo "Copilot CLI requires a token with Copilot access." >> review_result.md
            echo "Set up a PAT with \`copilot\` scope as \`COPILOT_TOKEN\` secret." >> review_result.md
          elif ! command -v copilot &> /dev/null; then
            REVIEW_AVAILABLE=false
            echo "‚ö†Ô∏è Copilot CLI is not available." > review_result.md
            echo "" >> review_result.md
            echo "Copilot CLI requires a token with Copilot access." >> review_result.md
            echo "Set up a PAT with \`copilot\` scope as \`COPILOT_TOKEN\` secret." >> review_result.md
          else
            if ! copilot -p "$(cat review_prompt.txt)" \
              --model gpt-5.2-codex \
              --allow-all-tools \
              > review_result.md 2>&1; then
              REVIEW_AVAILABLE=false
            fi
          fi

          # ÁµêÊûú„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
          if [ ! -s review_result.md ]; then
            REVIEW_AVAILABLE=false
            echo "## Review Result" > review_result.md
            echo "" >> review_result.md
            echo "Codex review could not be completed. Please review manually." >> review_result.md
          fi

          echo "review_available=$REVIEW_AVAILABLE" >> $GITHUB_OUTPUT

      - name: Post review comment
        if: steps.changed.outputs.has_files == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          {
            echo "## ü§ñ GPT-5.2-Codex Review"
            echo ""
            echo "---"
            echo ""
            cat review_result.md
            echo ""
            echo "---"
            echo "> üîç Automated review by GPT-5.2-Codex (medium)"
            echo "> [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } > /tmp/codex_review_comment.md

          gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/codex_review_comment.md

      - name: Post skip message
        if: steps.changed.outputs.has_files == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ü§ñ GPT-5.2-Codex Review

            No TypeScript/JavaScript files were changed in this PR. Skipping automated review.

            ---
            > [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Check if auto-fix needed
        if: steps.changed.outputs.has_files == 'true' && steps.review.outputs.review_available == 'true'
        id: check-fix
        run: |
          if grep -q "REQUEST_CHANGES" review_result.md; then
            echo "needs_fix=true" >> $GITHUB_OUTPUT
            echo "Critical issues detected, will trigger auto-fix"
          elif grep -q "Critical Issues:" review_result.md && grep -A 100 "Critical Issues:" review_result.md | grep -q "^-"; then
            echo "needs_fix=true" >> $GITHUB_OUTPUT
            echo "Critical issues found, will trigger auto-fix"
          else
            echo "needs_fix=false" >> $GITHUB_OUTPUT
            echo "No critical issues, no auto-fix needed"
          fi

      - name: Ensure labels exist
        if: steps.review.outputs.review_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create "codex-reviewed" --description "Codex Review completed" --color "0e8a16" 2>/dev/null || true
          gh label create "auto-fix" --description "Auto-fix triggered by review" --color "d93f0b" 2>/dev/null || true

      - name: Add labels and trigger auto-fix
        if: steps.review.outputs.review_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEEDS_FIX: ${{ steps.check-fix.outputs.needs_fix }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} \
            --add-label "codex-reviewed"

          if [ "$NEEDS_FIX" == "true" ]; then
            # „É©„Éô„É´ËøΩÂä†Ôºà„Éà„É©„ÉÉ„Ç≠„É≥„Ç∞Áî®Ôºâ
            gh pr edit ${{ github.event.pull_request.number }} \
              --add-label "auto-fix"

            # workflow_dispatch „ÅßËá™Âãï‰øÆÊ≠£„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíËµ∑Âãï
            gh workflow run auto-apply-suggestions.yml \
              -f pr_number=${{ github.event.pull_request.number }}
            echo "‚úÖ Triggered auto-fix workflow via workflow_dispatch"
          fi

      - name: Trigger auto-merge
        if: steps.check-fix.outputs.needs_fix == 'false' && steps.review.outputs.review_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "Checking PR #$PR_NUMBER for auto-merge..."

          # „Åæ„Å®„ÇÅ„Å¶PRÊÉÖÂ†±„ÇíÂèñÂæóÔºàÂäπÁéáÂåñÔºâ
          PR_INFO=$(gh pr view $PR_NUMBER --json mergeable,statusCheckRollup -q '.mergeable, .statusCheckRollup[] | select(.conclusion != "success" and .conclusion != null) | {name: .name, conclusion: .conclusion}')
 
          MERGEABLE=$(echo "$PR_INFO" | jq -r '.mergeable // "false"')
          FAILED_CHECKS=$(echo "$PR_INFO" | jq -r '.statusCheckRollup // [] | length')

          if [ "$FAILED_CHECKS" -eq 0 ]; then
            echo "All required checks passed, triggering auto-merge..."
 
            if [ "$MERGEABLE" == "true" ]; then
              gh pr merge $PR_NUMBER \
                --squash \
                --subject "Auto-merge after Codex review: ${{ github.event.pull_request.title }}"
              echo "‚úÖ Auto-merge triggered"
            else
              echo "‚ö†Ô∏è PR has conflicts, cannot auto-merge"
              gh pr comment $PR_NUMBER \
                --body "‚ÑπÔ∏è **Auto-merge skipped**

                Codex review approved, but PR has conflicts that need to be resolved.
                Please resolve conflicts and merge manually.

                ---
                [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            fi
          else
            echo "‚ö†Ô∏è Some checks have not passed ($FAILED_CHECKS failed)"
            gh pr comment $PR_NUMBER \
              --body "‚ÑπÔ∏è **Auto-merge pending**

              Codex review approved, but some checks have not passed yet ($FAILED_CHECKS failed).
              Auto-merge will be triggered once all checks pass.

              ---
              [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          fi
