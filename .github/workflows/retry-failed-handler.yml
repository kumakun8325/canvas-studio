name: Workflow Retry Handler

on:
  workflow_call:
    inputs:
      run_id:
        required: true
        type: number
      workflow_name:
        required: true
        type: string
      head_branch:
        required: false
        type: string
      run_attempt:
        required: false
        type: number
      repository:
        required: true
        type: string
      html_url:
        required: true
        type: string

jobs:
  handle-failure:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: Checkout for config
        uses: actions/checkout@v4
        with:
          sparse-checkout: '.github/config.env'
          sparse-checkout-cone-mode: false

      - name: Determine retry count
        id: retry
        run: |
          source .github/config.env

          RUN_ATTEMPT="${{ inputs.run_attempt }}"
          if [ -z "$RUN_ATTEMPT" ] || [ "$RUN_ATTEMPT" = "null" ]; then
            RUN_ATTEMPT=1
          fi

          echo "retry_count=$RUN_ATTEMPT" >> $GITHUB_OUTPUT

          if [ "$RUN_ATTEMPT" -lt "$MAX_RETRY_ATTEMPTS" ]; then
            echo "should_retry=true" >> $GITHUB_OUTPUT
          else
            echo "should_retry=false" >> $GITHUB_OUTPUT
          fi

      - name: Calculate backoff delay
        if: steps.retry.outputs.should_retry == 'true'
        id: backoff
        run: |
          case "${{ steps.retry.outputs.retry_count }}" in
            1) DELAY=60 ;;
            2) DELAY=300 ;;
            3) DELAY=900 ;;
            *) DELAY=0 ;;
          esac

          echo "delay=$DELAY" >> $GITHUB_OUTPUT

      - name: Wait before retry
        if: steps.retry.outputs.should_retry == 'true'
        run: sleep ${{ steps.backoff.outputs.delay }}

      - name: Trigger retry
        if: steps.retry.outputs.should_retry == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run rerun "${{ inputs.run_id }}" --failed --repo "${{ inputs.repository }}"

      - name: Find related PR
        if: steps.retry.outputs.should_retry == 'false'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ inputs.head_branch }}"
          if [ -z "$BRANCH" ] || [ "$BRANCH" = "null" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_NUMBER=$(gh pr list --repo "${{ inputs.repository }}" \
            --search "head:${BRANCH} base:main is:open" \
            --json number --limit 1 --jq '.[0].number')

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "found=true" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: steps.pr.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > /tmp/workflow_failure_comment.md << EOF
          ## Workflow failed after maximum retries

          - Workflow: ${{ inputs.workflow_name }}
          - Run ID: ${{ inputs.run_id }}
          - Attempts: ${{ steps.retry.outputs.retry_count }}
          - Run: ${{ inputs.html_url }}

          Please investigate the failure and address it manually.

          ---
          Auto-generated by Workflow Retry Handler
          EOF

          gh pr comment "${{ steps.pr.outputs.pr_number }}" \
            --repo "${{ inputs.repository }}" \
            --body-file /tmp/workflow_failure_comment.md

      - name: Create alert issue
        if: steps.pr.outputs.found != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > /tmp/workflow_failure_issue.md << EOF
          ## Workflow failed after maximum retries

          - Workflow: ${{ inputs.workflow_name }}
          - Run ID: ${{ inputs.run_id }}
          - Attempts: ${{ steps.retry.outputs.retry_count }}
          - Run: ${{ inputs.html_url }}

          Please investigate the failure and address it manually.

          ---
          Auto-generated by Workflow Retry Handler
          EOF

          gh issue create \
            --repo "${{ inputs.repository }}" \
            --title "Workflow Alert: Maximum Retries Reached - ${{ inputs.workflow_name }}" \
            --label "workflow-alert" \
            --assignee "${{ github.repository_owner }}" \
            --body-file /tmp/workflow_failure_issue.md
